var D="post-message-action";function se(e){return e.type===D&&typeof e.action=="object"}function k(e,t){function r(){return typeof e=="function"?e():e}function n(i){let s=r();!s||i.origin!==s.origin||i.source!==s||(se(i.data)?t(i.data.action):console.warn("Unknown message received",i.data))}function a(){window.removeEventListener("message",n)}function o(i){let s=r();if(!s)return;let p={type:D,action:i};s.postMessage(p,s.origin)}return window.addEventListener("message",n),{dispose:a,sendAction:o}}var R="boolean",U="integer",V="float",O="string",v="input",F="dropdown",L="checkbox";function pe(e){return function(r){return(r==null?void 0:r.type)===e}}function ce(e){return function(r){let n=[e,r].join(" ");function a(o){return{type:n,payload:o}}return a.type=n,a.match=pe(n),a}}var le="[ext]",u=ce(le),Y=u("icons-loaded"),E=u("control-selected"),B=u("select-control"),j=u("delete-property-changes"),H=u("outline-changed"),W=u("change-property"),G=u("property-changed"),z=u("change-property-failed"),N=u("change-stack-modified");async function $(e){let t;try{t=await X(e)}catch{console.error(`Error in getting document for ${e}`)}return t}async function X(e){let t=await de(e);if(t){let r=t.baseType;if(r){let n=await X(r);return Object.assign({},n,t.properties)}return Object.assign(Object.assign({},t.properties))}else return t}async function de(e){let t,r={method:"GET",cache:"force-cache",headers:{"Content-Type":"application/xml"}},n;try{n=await fetch(jQuery.sap.getModulePath(e,".control"),r)}catch{console.error("Error in fetching control metadata")}if((n==null?void 0:n.status)===200){let a=await n.text(),i=new DOMParser().parseFromString(a,"application/xml");t=ge(i.documentElement,e)}return t}function ge(e,t){let r=e.children,n=ye(r),a={baseType:q(n,t),doc:me(r),properties:{}},o=fe(e.children,"properties"),i=o==null?void 0:o.children;return ue(i).forEach(p=>{a.properties[p.propertyName]={...p}}),a}function ye(e){var n,a;let t=e.length,r="";for(let o=0;o<t;o++)if(e&&e.item(o)&&((n=e.item(o))==null?void 0:n.tagName)==="baseType"){r=((a=e.item(o))==null?void 0:a.innerHTML)||"";break}return r}function ue(e){var r,n,a,o;let t=[];for(let i in e){let s={propertyName:"",type:"",defaultValue:"",description:"",propertyType:""},p=parseInt(i);s.propertyName=((r=e==null?void 0:e.item(p))==null?void 0:r.getAttribute("name"))||"",s.type=q(((n=e==null?void 0:e.item(p))==null?void 0:n.getAttribute("type"))||"string")||"",s.description=K(((a=e==null?void 0:e.item(p))==null?void 0:a.textContent)||"")||"",s.defaultValue=((o=e==null?void 0:e.item(p))==null?void 0:o.getAttribute("defaultValue"))||"-",s.propertyType=Te(s.type),t.push(s)}return t}function me(e){return K(Ce(e))}function fe(e,t){var a;let r=e.length,n=null;for(let o=0;o<r;o++)if(e&&e.item(o)&&((a=e.item(o))==null?void 0:a.tagName)===t){n=e.item(o);break}return n}function Ce(e){var n,a;let t=e.length,r="";for(let o=0;o<t;o++)if(e&&e.item(o)&&((n=e.item(o))==null?void 0:n.tagName)==="documentation"){r=((a=e.item(o))==null?void 0:a.textContent)||"";break}return r}var J="boolean int float number function object string void any",he=J+" Element Control Component";function q(e,t){if(!e)return"";if(e.indexOf("/")!==-1)return e.replace(/\//g,".");if(e.indexOf(".")===-1&&he.indexOf(e)!==-1)return"sap.ui.core."+e;if(t)return t.split(".").slice(0,-1).concat([e.replace(/\//g,".")]).join(".")}function K(e){return e.replace(new RegExp("<[^>]*>","g"),"")}function Te(e){if(e){let t=e.replace(/^sap\.ui\.core\./,"");return J.indexOf(t.replace("[]",""))!==-1?t:e}}var Q=e=>{let t=e.replace(/([A-Z])/g," $1");return t.charAt(0).toUpperCase()+t.slice(1)};var Pe=/src|.*icon$|^icon.*/i;function ve(e){let t={primitiveType:"any",ui5Type:null,enumValues:null,isArray:!1};if(!e)return;let r=e.getType();if(!r)return;let n=r.getName();if(!!n){if(n.indexOf("[]")>0)t.primitiveType=n.substring(0,n.indexOf("[]")),t.isArray=!0;else if(n==="void"||n==="object")t.primitiveType=n;else if(n==="any")t.primitiveType="any";else if(n==="boolean"||n==="string"||n==="int"||n==="float")t.primitiveType=n;else{let a=window.sap.ui.base.DataType,o=a.getType(n);if(o&&!(o instanceof a))return t;let i=Object.getPrototypeOf(o).getName();i?t.primitiveType=i:t.primitiveType="enum",t.ui5Type=n,t.primitiveType==="enum"&&(t.enumValues=jQuery.sap.getObject(t.ui5Type))}return t}}function Ee(e){return!(e.isArray||e.primitiveType==="any")}function be(e){if(typeof e=="object"&&e instanceof Object&&!Array.isArray(e))try{return JSON.stringify(e)}catch(t){return t instanceof Error&&t.message.toLowerCase().includes("converting circular structure to json")?"<Circular JSON cannot be displayed>":e}else return typeof e=="function"?"":e}async function m(e,t,r=!0){let n=e.getMetadata(),a=n.getName(),o=sap.ui.fl.Utils.checkControlId(e),i=t?t.getDesignTimeMetadata().getData().properties:void 0,s=n.getAllProperties(),p=Object.keys(s),c=[],d=r?await $(a):{};for(let g of p){let l=s[g],y=ve(l);if(!y)continue;let A=!1;i&&i[l.name]&&(A=i[l.name].ignore);let x={id:e.getId(),name:l.name,newValue:e.getProperty(l.name)},P=e.getBindingInfo(x.name);(P==null?void 0:P.bindingString)!==void 0&&(x.newValue=P.bindingString);let f=((t==null?void 0:t.isSelectable())??!1)&&Ee(y)&&o&&!A,C=be(x.newValue),ae=Pe.test(l.name)&&a!=="sap.m.Image"&&y.ui5Type==="sap.ui.core.URI",h=d&&d[l.name]?d[l.name]:{defaultValue:l.defaultValue||"-",description:"",propertyName:l.name,type:y.ui5Type,propertyType:y.ui5Type},T=Q(l.name);switch(y.primitiveType){case"enum":{let _=y.enumValues??{},ie=Object.keys(_).map(M=>({key:M,text:_[M]}));c.push({type:O,editor:F,name:l.name,readableName:T,value:C,isEnabled:f,options:ie,documentation:h});break}case"string":{c.push({type:O,editor:v,name:l.name,readableName:T,value:C,isEnabled:f,isIcon:ae,documentation:h});break}case"int":{c.push({type:U,editor:v,name:l.name,readableName:T,value:C,isEnabled:f,documentation:h});break}case"float":{c.push({type:V,editor:v,name:l.name,readableName:T,value:C,isEnabled:f,documentation:h});break}case"boolean":{c.push({type:R,editor:L,name:l.name,readableName:T,value:C,isEnabled:f,documentation:h});break}}}return{id:e.getId(),type:a,properties:c.sort((g,l)=>g.name>l.name?1:-1),name:a}}var Z=async(e="")=>{let t=!1,r=sap.ui.getCore().byId(e);if(r){let n=sap.ui.dt.OverlayRegistry.getOverlay(r);(!n||!n.getDomRef())&&(n=sap.ui.dt.OverlayUtil.getClosestOverlayFor(r)),n&&(t=(await m(n.getElementInstance(),n,!1)).properties.find(i=>i.isEnabled===!0)!==void 0)}else{let n=sap.ui.getCore().getComponent(e);if(n){let o=(await m(n,void 0,!1)).properties.find(i=>i.isEnabled===!0);t=!1}}return t};async function S(e,t){let r=[...e],n=[];for(;r.length;){let a=r.shift(),o=await Z(a==null?void 0:a.id);if((a==null?void 0:a.type)==="element"){let i=(a.elements??[]).flatMap(c=>c.type==="aggregation"?c.elements??[]:[]),{text:s}=t(a.id),p={controlId:a.id,controlType:a.technicalName,name:s??a.technicalName.split(".").slice(-1)[0],editable:o,visible:a.visible??!0,children:await S(i,t)};n.push(p)}}return n}async function ee(e,t){let r=await e.getService("outline");async function n(){let a=await r.get(),o=await S(a,i=>{let s=sap.ui.getCore().byId(i);if(s&&s.getMetadata().getProperty("text")){let p=s.getProperty("text");return typeof p=="string"&&p.trim()!==""?{text:p}:{}}return{}});t(H(o))}r.attachEvent("update",n)}function te(){return{getControlById:Ie,getIcons:Se,getComponent:xe,getOverlay:Oe,getClosestOverlayFor:Ne}}function Ie(e){return sap.ui.getCore().byId(e)}function xe(e){return sap.ui.getCore().getComponent(e)}function Oe(e){return sap.ui.dt.OverlayRegistry.getOverlay(e)}function Ne(e){return sap.ui.dt.OverlayUtil.getClosestOverlayFor(e)}function Se(){return sap.ui.core.IconPool.getIconNames("undefined").map(e=>{let t=sap.ui.core.IconPool.getIconInfo(e);return{name:e.toLowerCase(),content:t.content,fontFamily:t.fontFamily}}).sort((e,t)=>e.name<t.name?-1:e.name>t.name?1:0)}function w(e){let t={method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)};fetch("./control-property-editor/report-telemetry",t).then(async r=>{console.log(r)}).catch(r=>{console.error("There was an error!",r)})}var b=class{constructor(t,r){this.rta=t;this.ui5=r;this.appliedChangeCache=new Map;this.activeChangeHandlers=new Set}init(t,r){let n=new Set;this.rta.attachSelectionChange(this.createOnSelectionChangeHandler(t,n)),r(async a=>{if(B.match(a)){let o=a.payload,i=this.ui5.getControlById(o);if(!i){let c=this.ui5.getComponent(o);if(c){let d=await m(c),g=E(d);t(g)}return}n.add("outline");let s=this.ui5.getOverlay(i),p=this.rta.getSelection();if(p.length>0)for(let c=0;c<p.length;c++)p[c].setSelected(!1);if((!s||!s.getDomRef())&&(s=this.ui5.getClosestOverlayFor(i)),s&&s.isSelectable())s.setSelected(!0);else{let c=await m(i),d=E(c);t(d)}}})}applyControlPropertyChange(t,r){let n=ne(t,r);this.appliedChangeCache.set(n,Date.now())}createOnSelectionChangeHandler(t,r){return async n=>{let a=n.getParameter("selection");for(let o of this.activeChangeHandlers)o();if(this.activeChangeHandlers.clear(),Array.isArray(a)&&a.length===1){let o=this.ui5.getControlById(a[0].getId());if(o){let i=o.getElementInstance(),s=i.getMetadata().getName();this.handlePropertyChanges(i,t);try{let p=r.has("outline"),c=s.toLowerCase().startsWith("sap")?s:"Other Control Types";p?w({category:"Outline Selection",controlName:c}):w({category:"Overlay Selection",controlName:c})}catch(p){console.error("Error in reporting telemetry",p)}finally{let p=await m(i,o),c=E(p);t(c),r.delete("outline")}}}}}handlePropertyChanges(t,r){let n=a=>{let o=a.getParameter("name"),i=a.getParameter("id"),s=ne(i,o);if(this.appliedChangeCache.get(s)){this.appliedChangeCache.delete(s);return}let c=t.getBindingInfo(o),d=(c==null?void 0:c.bindingString)??a.getParameter("newValue"),g=G({controlId:i,propertyName:o,newValue:d});r(g)};t.attachEvent("_change",n),this.activeChangeHandlers.add(()=>{try{t.detachEvent("_change",n)}catch{}})}};function ne(e,t){return[e,t].join(",")}var we="FE_FROM_SCRATCH";async function re(e,t){let{layer:r,componentId:n,rta:a,generator:o}=e,i=sap.ui.getCore().byId(t.controlId);if(!i)return;let s={layer:r,developerMode:!0,baseId:n,projectId:"",scenario:we,generator:o},p=typeof t.value=="string"&&oe(t.value)?"BindProperty":"Property",c=typeof t.value=="string"&&oe(t.value)?{generator:o,propertyName:t.propertyName,newBinding:t.value}:{generator:o,propertyName:t.propertyName,newValue:t.value},d=await sap.ui.rta.command.CommandFactory.getCommandFor(i,p,c,null,s);await a.getCommandStack().pushAndExecute(d)}function oe(e){return e.startsWith("{")&&e.endsWith("}")}var I=class{constructor(t,r,n){this.options=t;this.ui5=r;this.selectionService=n;this.savedChanges=[]}async init(t,r){r(async o=>{if(W.match(o))try{this.selectionService.applyControlPropertyChange(o.payload.controlId,o.payload.propertyName),await re(this.options,o.payload)}catch(i){let s="",p=o.payload.controlId||"",c=this.ui5.getControlById(p);c&&(s=c.getMetadata().getName());let g=Ae(i==null?void 0:i.toString(),p,s)||`RTA Exception applying expression "${o.payload.value}"`,l=z({...o.payload,errorMessage:g});t(l)}else j.match(o)&&await this.deleteChange(o.payload.controlId,o.payload.propertyName,o.payload.fileName)});let n=await fetch(`/FioriTools/api/getChanges?_=${Date.now()}`).then(o=>o.json()).catch(console.error),a=Object.keys(n??{}).map(o=>{let i=n[o];try{if(_e(["fileName","selector.id","content.property","creation"],i),[i.content.newValue,i.content.newBinding].every(s=>s==null))throw new Error("Invalid change, missing new value in the change file");return{type:"saved",kind:"valid",fileName:i.fileName,controlId:i.selector.id,propertyName:i.content.property,value:i.content.newValue??i.content.newBinding,timestamp:new Date(i.creation).getTime(),controlName:i.selector.type.split(".").pop()}}catch(s){if(i.fileName){let p={type:"saved",kind:"unknown",fileName:i.fileName};return i.creation&&(p.timestamp=new Date(i.creation).getTime()),p}console.error(s);return}}).filter(o=>!!o).sort((o,i)=>i.timestamp-o.timestamp);this.savedChanges=a,t(N({saved:a,pending:[]})),this.options.rta.attachUndoRedoStackModified(this.createOnStackChangeHandler(t))}async deleteChange(t,r,n){let a=this.savedChanges.filter(o=>n?n===o.fileName:o.controlId===t&&o.propertyName===r).map(o=>fetch("/FioriTools/api/removeChanges",{method:"DELETE",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileName:o.fileName})}));await Promise.all(a).catch(console.error)}createOnStackChangeHandler(t){return async()=>{let r=this.options.rta.getCommandStack(),n=r.getCommands(),a=r.getAllExecutedCommands(),o=n.length-a.length,i=n.map(function(s,p){try{let c=s.getProperty("selector"),d=s.getProperty("changeType"),g="";switch(d){case"propertyChange":g=s.getProperty("newValue");break;case"propertyBindingChange":g=s.getProperty("newBinding");break}return{type:"pending",controlId:c.id,propertyName:s.getProperty("propertyName"),isActive:p>=o,value:g,controlName:s.getElement().getMetadata().getName().split(".").pop()??""}}catch(c){console.error(c)}}).filter(s=>!!s);t(N({saved:this.savedChanges,pending:i}))}}};function Ae(e,t,r){return e.replace("Error: Applying property changes failed:","").replace(`${r}#${t}`,"")}function _e(e,t){for(let r of e){let n=Me(r,t);if(n==null)throw new Error(`Invalid change, missing ${r} in the change file`)}}function Me(e,t){let r=e.split("."),n=t;for(let a of r)n=n[a];return n}function De(e){console.log("Initializing Control Property Editor");let{rta:t}=e,r=te(),n=[];function a(p){n.push(p)}let o=new b(t,r),i=new I(e,r,o),s=[o,i];try{let{sendAction:p}=k(window.parent,async function(g){for(let l of n)try{await l(g)}catch(y){console.error(y)}});for(let d of s)d.init(p,a);ee(t,p);let c=r.getIcons();p(Y(c))}catch(p){console.error("Error during initialization of Control Property Editor",p)}}export{De as init};
//# sourceMappingURL=ui5-adaptation.js.map
